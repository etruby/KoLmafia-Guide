# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is **Guide** (aka KoLmafia-Guide), a relay script for [KoLmafia](http://kolmafia.sourceforge.net) that provides real-time advice for playing [Kingdom of Loathing](http://www.kingdomofloathing.com). The script runs in KoLmafia's relay browser and provides quest guidance, resource tracking, and strategic recommendations during ascension.

## Language and Environment

- **Language**: ASH (Asymmetric Script Handling) - KoLmafia's scripting language
- **Runtime**: KoLmafia relay browser
- **Version**: Current version is tracked in [Source/relay/KoLmafia-Guide/Settings.ash](Source/relay/KoLmafia-Guide/Settings.ash) (`__version` variable)

### Web Content Fetching (for getting around 403 errors)
When needing to fetch web content (documentation, specifications, etc.) and the WebFetch tool is blocked or returns poor results, use a local script instead. Only use if the initial WebFetch fails:
powershell

# PowerShell example
powershell -Command "(Invoke-WebRequest -Uri 'https://wiki.kingdomofloathing.com/index.php?search=leprechaun+condo+furniture' -UseBasicParsing).Content" 2>&1 | head -200

This avoids LLM-specific blocking and provides first-class access to web resources.

## Build and Development

### Compilation

The project uses a modular development structure that compiles into a single release file:

```bash
# Compile from source to release
ruby "Compile ASH script.rb" "Source/relay/relay_KoLmafia_Guide.ash" "Release/relay/relay_Guide.ash"
```

The Ruby compilation script (`Compile ASH script.rb`) recursively processes all `import` statements, merging ~230 modular `.ash` files from `Source/` into a single distributable script in `Release/`.

**Note:** The Ruby compilation step can be skipped during development. It only compresses the modular source files into a single script for deployment. KoLmafia can run the modular `Source/` version directly during testing.

### Directory Structure

- **Source/relay/** - Development version (modular, ~230 files)
  - `relay_KoLmafia_Guide.ash` - Entry point script
  - **KoLmafia-Guide/** - Main codebase
    - `Main.ash` - Primary orchestrator, imports all modules
    - **Support/** - Core libraries and utilities
    - **Sections/** - UI components and page generation
    - **Quests/** - Quest-specific logic and advice
    - **Items of the Month/** - IOTM-specific functionality
    - **Paths/** - Ascension path-specific features
    - **Limit Mode/** - Challenge path handling
    - **Sets/** - Item set management
- **Release/relay/** - Compiled single-file version for distribution
  - `relay_Guide.ash` - The compiled output (~2.7 MB)
  - `GuideBrowserSide.js` - Client-side JavaScript
- **Matrix/** - Visualization tool (separate utility)

## Architecture

### Core Flow

1. **Entry Point**: `relay_KoLmafia_Guide.ash` imports and calls `Main.ash`
2. **Main.ash**: Orchestrates the entire application by importing all modules and running `runMain()`
3. **Form Processing**: Handles API requests, user preference updates, or full page generation
4. **Page Generation**: Builds HTML with navigation, checklists, and resource tracking
5. **Output**: Writes HTML/JSON response to relay browser

### Key Components

- **Settings.ash**: Version number, debug flags, display settings, color scheme variables
- **State.ash**: Game state tracking and analysis
- **Tasks.ash**: Task generation and prioritization logic
- **Strategy.ash**: Strategic advice and resource optimization
- **Sections/**: Page structure components
  - `API.ash` - JSON API for client-side updates
  - `CSS.ash` - Style generation
  - `Checklists.ash` - Main content generation
  - `Navigation Bar.ash`, `Resource Bar.ash`, `Location Bar.ash` - UI bars
- **Support/**: Utility libraries
  - `Library.ash`, `Library 2.ash` - Core utility functions
  - `HTML.ash` - HTML generation helpers
  - `IOTMs.ash` - Item of the Month detection
  - `Statics.ash`, `Statics 2.ash` - Static data and constants
  - `List.ash` - List manipulation utilities
  - `Math.ash` - Mathematical utilities
  - `Counter.ash` - Counter tracking

### Import System

ASH uses `import "path/to/file.ash"` statements. The compiler:
- Processes imports recursively
- Supports relative paths and KoLmafia absolute paths (`relay/`, `scripts/`)
- Prevents duplicate imports (each file imported only once)
- Inlines all imported code into the final output

## Development Guidelines

### Critical Rules

1. **No Server Connections**: Never use `visit_url()` or any function that connects to KOL's servers. This is a **local-only** application that reads from KoLmafia's internal state.

2. **Modular Development**: Always edit files in `Source/`, never directly edit `Release/relay/relay_Guide.ash`. The release version is generated by compilation.

3. **Import Order**: `Main.ash` establishes the import order. Dependencies must be imported before files that use them.

### Code Organization

- **Quest Logic**: Add new quests in `Quests/` directory
- **IOTM Features**: Add new IOTM support in `Items of the Month/` directory
- **Path Features**: Add new ascension paths in `Paths/` directory
- **Utility Functions**: Add to appropriate file in `Support/` directory
- **UI Components**: Modify files in `Sections/` directory

### Version Management

Update the version number in [Settings.ash](Source/relay/KoLmafia-Guide/Settings.ash) when making significant changes:
```ash
string __version = "2.0.7";
```

## IOTM Implementation Guide

### Files to Modify

When adding a new IOTM, you need to touch these files:
1. **Create**: `Source/relay/KoLmafia-Guide/Items of the Month/YourIOTM.ash`
2. **Edit**: `Source/relay/KoLmafia-Guide/Items of the Month/Items of the Month import.ash` - add import
3. **Edit**: `Source/relay/KoLmafia-Guide/Support/IOTMs.ash` - add to `__iotms_usable` detection (for workshed/campground items)

### Registration Pattern

IOTMs register callback functions that Guide calls to generate entries:

```ash
// For resource tracking (right sidebar)
RegisterResourceGenerationFunction("IOTMYourIOTMGenerateResource");
void IOTMYourIOTMGenerateResource(ChecklistEntry [int] resource_entries)
{
    if (!yourIOTMIsAvailable()) return;
    // Build description and add entry
    resource_entries.listAppend(ChecklistEntryMake(ITEM_ID, "__item item name", url,
        ChecklistSubentryMake(title, modifiers, description), importance));
}

// For task suggestions (main checklist)
RegisterTaskGenerationFunction("IOTMYourIOTMGenerateTasks");
void IOTMYourIOTMGenerateTasks(ChecklistEntry [int] task_entries,
    ChecklistEntry [int] optional_task_entries, ChecklistEntry [int] future_task_entries)
{
    // task_entries = important tasks
    // optional_task_entries = optional/reminder tasks
    // future_task_entries = tasks for later
}
```

### Common Utility Functions

```ash
// Property access
get_property_int("propertyName")           // Integer properties
get_property_boolean("propertyName")       // Boolean properties
get_property("propertyName")               // String properties
get_property_ascension("propertyName")     // Returns true if property equals current ascension number

// List utilities
listMake("a", "b", "c")                    // Create string array
listAppend(list, "item")                   // Add to list
listJoinComponents(list, ", ")             // Join with delimiter

// HTML helpers
HTMLGenerateSpanFont(text, "red")          // Colored text

// Game state
__misc_state["in run"]                     // True if in-run
__misc_state["campground unavailable"]     // True if no campground access
get_campground()                           // Returns int[item] map of campground items

// Checklist entries
ChecklistEntryMake(universal_id, image, url, subentry, importance)
// universal_id: Required int parameter (first arg) - use sequential IDs within each file
// Example: Misc Tasks.ash uses 392-401, find the next available ID in the file you're editing
```

### Property Naming Conventions

- `_propertyName` (underscore prefix) = Daily property, resets each rollover
- `propertyName` (no underscore) = Persistent property

### Template Reference

**[Leprecondo.ash](Source/relay/KoLmafia-Guide/Items of the Month/Leprecondo.ash)** is the best template for complex IOTMs with:
- State parsing (comma-separated values)
- Daily counters
- Resource tracking
- Both Resource and Task generation

**[Latte.ash](Source/relay/KoLmafia-Guide/Items of the Month/Latte.ash)** is a simpler template for basic daily resource tracking.

## IOTM Research Resources

When implementing new Items of the Month, these resources are helpful:

- **[loathers.net](https://www.loathers.net/analysis/)** - Detailed IOTM analysis with mechanics, speedrun value, and synergies
- **[KoLmafia source code](https://github.com/kolmafia/kolmafia)** - Check `src/data/defaults.txt` for property names and tracking

**Note on Wiki Access:**
- **wiki.kingdomofloathing.com** - Returns 403 Forbidden for Claude requests, possibly use powershell workaround
- **kol.coldfront.net/thekolwiki** - Often unavailable (connection refused) and may be out of date
- Use loathers.net analysis and KoLmafia source code as primary references

### Quest-Specific IOTMs

Some IOTMs provide bonuses for specific quests rather than general daily resources. For these:

1. **Check existing quest files first** - They may already reference the item (e.g., Level 9.ash already had bat wings bridge crossing logic)
2. **Access quest state** via `__quest_state["Level X"]`:
   - `.in_progress` - Boolean, quest is active
   - `.mafia_internal_step` - Integer, quest progress step
   - `.state_int["key"]` - Integer state values
   - `.state_boolean["key"]` - Boolean state values
3. **Check zone availability** with `$location[zone name].locationAvailable()`
4. **Add task suggestions** that appear only when the relevant quest is active

**[Bat Wings.ash](Source/relay/KoLmafia-Guide/Items of the Month/Bat Wings.ash)** is a good template for quest-specific IOTMs with:
- Multiple quest checks (Level 4, 9, 10)
- Conditional task generation based on quest progress
- Equipment status checks

---

## Session End Checklist

At the end of each coding session, complete these steps:

1. **Update IOTM_IMPLEMENTATION_PLAN.md** - Mark completed items with âœ…
2. **Document learnings in CLAUDE.md** - Add any new patterns, gotchas, or useful techniques discovered
3. **Note any incomplete work** - Update plan with next steps if work is unfinished
